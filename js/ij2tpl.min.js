(function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).IJ2TPL={})})(this,function(e){"use strict";function h(e,r){var t;4===e[0]&&(t=e[1],n.test(t)&&(t=t.replace(i,"")),t?e[1]=t:r.pop())}var r,p={},d=((r={})["?"]=0,r["!"]=1,r["*"]=2,r["/"]=3,r["#"]=5,r["@"]=8,r),v=/[\s\xA0\uFEFF]+/g,n=/(?:^|[\n\r])[\t \xA0\uFEFF]+$/,i=/[\t \xA0\uFEFF]+$/;function o(e,r,t){for(var n,i,o,a=[7,""],s=[],l=0,c=e.length,f=r.length,u=t.length;l<c;){if(-1===(o=e.indexOf(r,l))){(i=e.slice(l))&&(a=[4,i],s.push(a));break}if(i=e.slice(l,o),o+=f,i&&(a=[4,i],s.push(a)),-1===(l=e.indexOf(t,o)))throw new Error("No matching prefix '"+r+"'");if("-"!==e[o]){if(i=e.slice(o,l),l+=u,i=i.replace(v,""))switch(n=i[0]){case"?":case"!":case"*":case"/":case"@":if(h(a,s),l<c)switch(e[l]){case"\n":l+=1;break;case"\r":l+=(o=l+1)<c&&"\n"===e[o]?2:1}case"#":a=[d[n],i.slice(1)],s.push(a);break;default:a=[6,i],s.push(a)}}else h(a,s),l+=u}return s}function w(e){return String(e).replace(t,function(e){return a[e]})}var g={}.hasOwnProperty,t=/["&'\/<=>`]/g,a={'"':"&quot;","&":"&amp;","'":"&#39;","/":"&#x2F;","<":"&lt;","=":"&#x3D;",">":"&gt;","`":"&#x60;"},b=w,k=(s.prototype.resolve=function(e){var r,t,n,i,o,a,s=null,l=this,c=!1;if(!e[3])if(t=l.cache,n=e[0],g.call(t,n))s=t[n];else{(o=e[1])?(i=o[0],c=!0):i=n;do{if((r=l.data)&&g.call(r,i)){if(s=r[i],c)for(var f=1,u=o.length;f<u;f++){if(i=o[f],!s||!g.call(s,i)){s=null;break}s=s[i]}break}}while(l=l.parent);"function"==typeof s&&(s=s(l)),t[n]=s}if(a=e[2])for(var h,f=0,u=a.length;f<u;){if(h=a[f++],!g.call(p,h))throw new Error("Cannot resolve filter '"+h+"'");s=p[h](s)}return s},s);function s(e,r){this.data=e,this.cache={".":this.data},this.parent=r}var l,x=Array.isArray;x||(l={}.toString,x=function(e){return"[object Array]"===l.call(e)});var c=(f.prototype.renderTree=function(e,r,t){for(var n,i,o,a,s="",l=!1,c=0,f=e.length;c<f;)switch((a=e[c++])[0]){case 0:if(o=a,n=r.resolve(o[1]),(l=x(n))?i=n.length:n)if(l)for(var u=0,h=i,p=void 0;u<h;)p=n[u++],s+=this.renderTree(o[2],new k(p,r),t);else s+=this.renderTree(o[2],new k(n,r),t);break;case 1:o=a,n=r.resolve(o[1]),((l=x(n))?n.length:n)||(s+=this.renderTree(o[2],r,t));break;case 2:if(o=a,n=r.resolve(o[1]),(l=x(n))?i=n.length:n)if(l)for(var d=0,v=i,p=void 0;d<v;)p=n[d++],s+=this.renderTree(o[2],new k(p,r),t);else s+=this.renderTree(o[2],new k(n,r),t);else s+=this.renderTree(o[3],r,t);break;case 4:s+=n=a[1];break;case 5:null!=(n=r.resolve(a[1]))&&(s+=n);break;case 6:null!=(n=r.resolve(a[1]))&&(s+=b===w&&"number"==typeof n?n:b(n));break;case 8:if(n=a[1],!t||!g.call(t,n))throw new Error("Cannot resolve partial '"+n+"'");s+=this.renderTree(t[n].treeRoot,r,t)}return s},f.prototype.render=function(e,r){return this.renderTree(this.treeRoot,new k(e,null),r)},f);function f(e){this.treeRoot=e}function y(e){var r=null,t=null,n=!1,i=e[1];return-1!==i.indexOf("|")&&(i=(t=i.split("|"))[0],t=t.slice(1),i||(n=!0)),0<i.indexOf(".")&&(r=i.split(".")),[e[0],[i,r,t,n]]}var F=((r={})[0]="?",r[1]="!",r[2]="*",r[3]="/",r);e.Context=k,e.Renderer=c,e.escape=function(e){return b(e)},e.parse=function(e,r,t){return void 0===r&&(r="{"),void 0===t&&(t="}"),t=function(e){for(var r,t,n,i,o,a,s,l=[],c=[],f=c,u=0,h=e.length;u<h;)switch(r=(s=e[u++])[0]){case 0:case 1:n=y(s),f.push(n),o=n,l.push(o),f=o[2]=[],o[3]=null;break;case 2:if(o=(a=l.length)?l[a-1]:void 0,t=s[1],!o||0!==o[0]||t!==o[1][0])throw new Error("Unexpected token '<type="+F[r]+", value="+t+">'");f=o[3]=[];break;case 3:if(o=l.pop(),t=s[1],!o||t!==o[1][0])throw new Error("Unexpected token '<type="+F[r]+", value="+t+">'");o[3]&&(o[0]=2),f=(a=l.length)?(i=(o=l[a-1])[3])?i:o[2]:c;break;case 5:case 6:n=y(s),f.push(n);break;default:f.push(s)}if(l.length)throw o=l.pop(),new Error("No matching section '<type="+F[o[0]]+", value="+o[1][0]+">'");return c}(o(e,r,t)),new c(t)},e.setEscapeFunction=function(e){b=e},e.setFilterMap=function(e){p=e},e.tokenize=o,e.version="0.1.2",e.__esModule=!0});