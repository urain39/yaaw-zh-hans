(function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).IJ2TPL={})})(this,function(e){"use strict";function p(e,r){var t,n,i="";return 4===e[0]&&((n=(t=e[1]).match(a))&&(i=n[2],t=t.replace(o,"")),t?e[1]=t:r.pop()),i}var r,d={},v=((r={})["?"]=0,r["!"]=1,r["*"]=2,r["/"]=3,r["#"]=5,r["@"]=8,r),a=/(^|[\n\r])([\t \xA0\uFEFF]+)$/,o=/[\t \xA0\uFEFF]+$/,w=/[\s\xA0\uFEFF]+/g;function n(e,r,t){for(var n,i,a,o,s=[7,""],l=[],c=0,f=e.length,u=r.length,h=t.length;c<f;){if(-1===(o=e.indexOf(r,c))){(i=e.slice(c))&&(s=[4,i],l.push(s));break}if(i=e.slice(c,o),o+=u,i&&(s=[4,i],l.push(s)),-1===(c=e.indexOf(t,o)))throw new Error("No matching prefix '"+r+"'");if("-"!==e.charAt(o)){if(i=e.slice(o,c),c+=h,i=i.replace(w,""))switch(n=i.charAt(0)){case"?":case"!":case"*":case"/":case"@":if(a=p(s,l),c<f)switch(e.charAt(c)){case"\n":c+=1;break;case"\r":c+=(o=c+1)<f&&"\n"===e.charAt(o)?2:1}s=[v[n],i.slice(1),a],l.push(s);break;case"#":s=[v[n],i.slice(1)],l.push(s);break;default:s=[6,i],l.push(s)}}else p(s,l),c+=h,s=[7,""]}return l}function b(e){return String(e).replace(t,function(e){return i[e]})}var k={}.hasOwnProperty,t=/["&'\/<=>`]/g,i={'"':"&quot;","&":"&amp;","'":"&#39;","/":"&#x2F;","<":"&lt;","=":"&#x3D;",">":"&gt;","`":"&#x60;"},x=b,y=(s.prototype.resolve=function(e){var r,t,n,i,a,o,s=null,l=this,c=!1;if(!e[3])if(t=l.cache,n=e[0],k.call(t,n))s=t[n];else{(a=e[1])?(i=a[0],c=!0):i=n;do{if((r=l.data)&&k.call(r,i)){if(s=r[i],c)for(var f=1,u=a.length;f<u;f++){if(i=a[f],!s||!k.call(s,i)){s=null;break}s=s[i]}break}}while(l=l.parent);"function"==typeof s&&(s=s(l)),t[n]=s}if(o=e[2])for(var h,f=0,u=o.length;f<u;){if(h=o[f++],!k.call(d,h))throw new Error("Cannot resolve filter '"+h+"'");s=d[h](s,l)}return s},s);function s(e,r){this.data=e,this.cache={".":this.data},this.parent=r}var l,T=Array.isArray;T||(l={}.toString,T=function(e){return"[object Array]"===l.call(e)});var c=(f.prototype.renderTree=function(e,r,t){for(var n,i,a,o,s,l=/^(.+)$/gm,c="",f=!1,u=0,h=e.length;u<h;)switch((s=e[u++])[0]){case 0:if(a=s,n=r.resolve(a[1]),(f=T(n))?i=n.length:n)if(f)for(var p=0,d=i,v=void 0;p<d;)v=n[p++],c+=this.renderTree(a[2],new y(v,r),t);else c+=this.renderTree(a[2],new y(n,r),t);break;case 1:a=s,n=r.resolve(a[1]),((f=T(n))?n.length:n)||(c+=this.renderTree(a[2],r,t));break;case 2:if(a=s,n=r.resolve(a[1]),(f=T(n))?i=n.length:n)if(f)for(var w=0,g=i,v=void 0;w<g;)v=n[w++],c+=this.renderTree(a[2],new y(v,r),t);else c+=this.renderTree(a[2],new y(n,r),t);else c+=this.renderTree(a[3],r,t);break;case 4:c+=n=s[1];break;case 5:null!=(n=r.resolve(s[1]))&&(c+=n);break;case 6:null!=(n=r.resolve(s[1]))&&(c+=x===b&&"number"==typeof n?n:x(n));break;case 8:if(n=s[1],o=s[2],"&"===n)c+=this.renderTree(this.treeRoot,r,t).replace(l,o+"$&");else if("^"===n)c+=this.renderTree(this.treeRoot,new y(r.data,null),t).replace(l,o+"$&");else{if(!t||!k.call(t,n))throw new Error("Cannot resolve partial '"+n+"'");c+=this.renderTree(t[n].treeRoot,r,t).replace(l,o+"$&")}}return c},f.prototype.render=function(e,r){return this.renderTree(this.treeRoot,new y(e,null),r)},f);function f(e){this.treeRoot=e}function g(e){var r=null,t=null,n=!1,i=e[1];return-1!==i.indexOf("|")&&(i=(t=i.split("|"))[0],t=t.slice(1),i||(n=!0)),0<i.indexOf(".")&&(r=i.split(".")),[e[0],[i,r,t,n]]}var F=((r={})[0]="?",r[1]="!",r[2]="*",r[3]="/",r);e.Context=y,e.Renderer=c,e.escape=function(e){return x(e)},e.parse=function(e,r,t){return void 0===r&&(r="{"),void 0===t&&(t="}"),t=function(e){for(var r,t,n,i,a,o,s,l=[],c=[],f=c,u=0,h=e.length;u<h;)switch(r=(s=e[u++])[0]){case 0:case 1:n=g(s),f.push(n),a=n,l.push(a),f=a[2]=[],a[3]=null;break;case 2:if(a=(o=l.length)?l[o-1]:void 0,t=s[1],!a||0!==a[0]||t!==a[1][0])throw new Error("Unexpected token '<type="+F[r]+", value="+t+">'");f=a[3]=[];break;case 3:if(a=l.pop(),t=s[1],!a||t!==a[1][0])throw new Error("Unexpected token '<type="+F[r]+", value="+t+">'");a[3]&&(a[0]=2),f=(o=l.length)?(i=(a=l[o-1])[3])?i:a[2]:c;break;case 5:case 6:n=g(s),f.push(n);break;default:f.push(s)}if(l.length)throw a=l.pop(),new Error("No matching section '<type="+F[a[0]]+", value="+a[1][0]+">'");return c}(n(e,r,t)),new c(t)},e.setEscapeFunction=function(e){x=e},e.setFilterMap=function(e){d=e},e.tokenize=n,e.version="0.1.3",e.__esModule=!0});